<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Agenda Pro</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- ESTILOS GERAIS --- */
        body { 
            background-color: #f8fafc; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding-bottom: 90px; /* Espaço para navbar mobile */
            color: #334155; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
        }

        /* --- ANIMAÇÕES E BOTÕES --- */
        .btn-primary { 
            background-color: #3b82f6; 
            color: white; 
            border-radius: 12px; 
            transition: background-color 0.2s, transform 0.1s; 
        }
        .btn-primary:active { 
            transform: scale(0.96); 
            background-color: #2563eb; 
        }
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .btn-anim { 
            transition: transform 0.15s ease; 
        }
        .btn-anim:active { 
            transform: scale(0.95); 
        }

        /* --- SPINNER DE CARREGAMENTO --- */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        .spinner-dark { 
            border-color: rgba(0,0,0,0.1); 
            border-top-color: #334155; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* --- MODAIS --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 60; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(2px); 
            padding: 16px; 
        }
        .modal-overlay.open { 
            display: flex; 
        }
        .modal-card { 
            background: white; 
            width: 100%; 
            max-width: 400px; 
            border-radius: 20px; 
            padding: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        .modal-tabs { 
            display: flex; 
            border-bottom: 1px solid #e2e8f0; 
            margin-bottom: 16px; 
        }
        .modal-tab { 
            flex: 1; 
            text-align: center; 
            padding: 12px 8px;
            font-size: 0.9rem; 
            font-weight: 600; 
            color: #94a3b8; 
            cursor: pointer; 
        }
        .modal-tab.active { 
            color: #3b82f6; 
            border-bottom: 2px solid #3b82f6; 
        }
        .modal-tab-content { 
            display: none; 
        }
        .modal-tab-content.active { 
            display: block; 
        }

        /* --- AGENDA / TIMELINE --- */
        .time-slot { 
            display: flex; 
            border-bottom: 1px solid #f1f5f9; 
            position: relative; 
        }
        .time-label { 
            width: 55px; 
            text-align: right; 
            padding-right: 8px; 
            color: #94a3b8; 
            font-size: 0.75rem; 
            font-weight: 500; 
            flex-shrink: 0; 
            transform: translateY(-50%); 
            padding-top: 0; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            height: 1px; 
        }
        .time-slot::before { 
            content: ''; 
            position: absolute; 
            left: 55px; 
            right: 0; 
            top: 0; 
            border-top: 1px dashed #e2e8f0; 
            pointer-events: none; 
        }
        .slot-content { 
            flex-grow: 1; 
            position: relative; 
            height: 100%; 
        }
        .slot-livre-area { 
            width: 100%; 
            height: 100%; 
            cursor: pointer; 
        }
        .slot-livre-area:active { 
            background-color: #f1f5f9; 
        }

        /* --- CARTÃO DE EVENTO --- */
        .event-card { 
            position: absolute; 
            border-radius: 6px; 
            padding: 4px 6px; 
            font-size: 0.75rem; 
            cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.08); 
            z-index: 10; 
            border-left: 4px solid; 
            overflow: hidden; 
            line-height: 1.2; 
            transition: transform 0.1s; 
        }
        .event-card:active { 
            transform: scale(0.98); 
            z-index: 20; 
        }
        
        /* Status Especiais */
        .status-confirmado { 
            border: 2px solid #10b981 !important; 
            border-left-width: 4px !important; 
        }
        .status-concluido { 
            background-color: #f1f5f9 !important; 
            border-left-color: #64748b !important; 
            opacity: 0.8; 
            color: #64748b !important; 
        }
        .status-cancelado { 
            background-color: #fef2f2 !important; 
            border-left-color: #ef4444 !important; 
            text-decoration: line-through; 
            opacity: 0.6; 
            color: #ef4444 !important; 
        }

        /* --- NAVEGAÇÃO E UTILS --- */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; border-top: 1px solid #e2e8f0; 
            display: flex; justify-content: space-around; 
            padding: 12px 0; z-index: 50; 
            padding-bottom: max(12px, env(safe-area-inset-bottom)); 
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; 
            font-size: 0.7rem; color: #94a3b8; gap: 4px; cursor: pointer; 
            flex: 1; 
            padding: 4px 0;
        }
        .nav-item.active { 
            color: #3b82f6; font-weight: 600; 
        }
        .tab-content { 
            display: none; 
            padding: 16px; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        .tab-content.active { 
            display: block; 
        }
        .fab { 
            position: fixed; bottom: 85px; right: 20px; 
            background-color: #3b82f6; color: white; 
            width: 56px; height: 56px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); 
            cursor: pointer; z-index: 40; 
        }
        
        .color-option { 
            width: 35px; height: 35px; border-radius: 50%; 
            cursor: pointer; border: 2px solid transparent; 
        }
        .color-option.selected { 
            border-color: #333; transform: scale(1.1); 
        }
        
        #login-screen { 
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: #f8fafc; z-index: 100; 
            display: flex; align-items: center; justify-content: center; 
            padding: 20px; 
        }
        
        #sync-indicator {
            position: fixed; top: 16px; right: 16px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 4px 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            transition: opacity 0.3s;
        }
        
        input, select, textarea {
            font-size: 16px !important; 
        }
    </style>
</head>
<body>

    <!-- ================== TELA DE LOGIN ================== -->
    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <div class="mb-6 flex justify-center text-blue-600">
                <i data-lucide="calendar-check" class="w-12 h-12"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Bem-vindo</h1>
            <p class="text-slate-400 text-sm mb-6">Acesse sua agenda profissional</p>
            
            <form onsubmit="fazerLogin(event)">
                <div class="space-y-4 mb-4">
                    <input type="email" id="login-email" required placeholder="Email" 
                        class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-base">
                    <input type="password" id="login-senha" required placeholder="Senha" 
                        class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-base">
                </div>
                
                <div class="flex items-center gap-2 mb-6 text-left px-1">
                    <input type="checkbox" id="login-manter" class="w-4 h-4 text-blue-600 rounded" checked>
                    <label for="login-manter" class="text-sm text-slate-500 cursor-pointer">Manter conectado</label>
                </div>

                <button type="submit" id="btn-login" 
                    class="w-full py-3 btn-primary font-bold shadow-lg shadow-blue-200 btn-anim">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Indicador de Sincronização em Background -->
    <div id="sync-indicator">
        <div class="spinner spinner-dark w-3 h-3"></div>
        <span>Sincronizando...</span>
    </div>

    <!-- ================== CABEÇALHO ================== -->
    <header id="app-header" class="bg-white px-5 py-4 shadow-sm sticky top-0 z-20 flex justify-between items-center hidden">
        <div>
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2 tracking-tight">
                <i data-lucide="calendar-days" class="w-5 h-5 text-blue-600"></i> 
                <span id="header-title">Minha Agenda</span>
            </h1>
            <p class="text-xs text-slate-400" id="user-name-display"></p>
        </div>
        <div class="flex items-center gap-3">
            <select id="select-profissional-agenda" onchange="mudarProfissionalAgenda()" 
                class="hidden text-xs bg-slate-100 border-none rounded-lg p-1 text-slate-600 outline-none text-base">
            </select>
            <button onclick="logout()" class="text-slate-400 hover:text-red-500">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- ================== ABAS PRINCIPAIS ================== -->

    <!-- 1. AGENDA -->
    <div id="tab-agenda" class="tab-content active">
        <div class="bg-white rounded-2xl p-4 mb-4 shadow-sm flex justify-between items-center border border-slate-100 sticky top-0 z-10">
            <button onclick="mudarDia(-1)" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-full text-slate-500 btn-anim">
                <i data-lucide="chevron-left"></i>
            </button>
            <div class="text-center">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1" id="dia-semana-display">Hoje</p>
                <input type="date" id="data-picker" 
                    class="text-base font-bold text-slate-800 bg-transparent text-center outline-none cursor-pointer w-full" 
                    onchange="atualizarDataEPainel()">
            </div>
            <button onclick="mudarDia(1)" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-full text-slate-500 btn-anim">
                <i data-lucide="chevron-right"></i>
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-[400px]">
            <div id="agenda-timeline" class="timeline-container pl-2 pr-2 pt-4 pb-10">
                <div class="p-10 text-center text-slate-400">
                    <div class="spinner spinner-dark mx-auto mb-2 border-slate-300 border-t-blue-500"></div>
                    <p>A carregar agenda...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. SERVIÇOS -->
    <div id="tab-servicos" class="tab-content admin-only">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Serviços</h2>
            <button onclick="abrirModalServico()" class="text-blue-600 text-sm font-bold bg-blue-50 px-3 py-1.5 rounded-lg btn-anim">+ Novo</button>
        </div>
        <div id="lista-servicos" class="space-y-3 pb-24">
            <div class="text-center text-slate-400 py-10">Carregando...</div>
        </div>
    </div>

    <!-- 3. PACOTES -->
    <div id="tab-pacotes" class="tab-content admin-only">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Pacotes Ativos</h2>
            <button onclick="abrirModalVenderPacote()" class="text-blue-600 text-sm font-bold bg-blue-50 px-3 py-1.5 rounded-lg btn-anim">+ Vender</button>
        </div>
        <div id="lista-pacotes" class="space-y-3 pb-24">
            <div class="text-center text-slate-400 py-10">Carregando pacotes...</div>
        </div>
    </div>

    <!-- 4. EQUIPA -->
    <div id="tab-equipa" class="tab-content admin-only">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-slate-800">Profissionais</h2>
            <button onclick="abrirModalUsuario()" class="text-blue-600 text-sm font-bold bg-blue-50 px-3 py-1.5 rounded-lg btn-anim">+ Novo</button>
        </div>
        <div id="lista-usuarios" class="space-y-3 pb-24">
            <div class="text-center text-slate-400 py-10">Carregando equipa...</div>
        </div>
    </div>

    <!-- 5. CONFIGURAÇÕES -->
    <div id="tab-config" class="tab-content admin-only">
        <h2 class="text-xl font-bold text-slate-800 mb-6">Configurações</h2>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-6">
            <div>
                <label class="block text-sm text-slate-600 mb-1 font-medium">Abertura</label>
                <input type="time" id="cfg-abertura" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none text-base">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1 font-medium">Fecho</label>
                <input type="time" id="cfg-fechamento" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none text-base">
            </div>
            <div>
                <label class="block text-sm text-slate-600 mb-1 font-medium">Intervalo (min)</label>
                <select id="cfg-intervalo" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none text-base">
                    <option value="15">15 min</option>
                    <option value="30">30 min</option>
                    <option value="60">1 hora</option>
                </select>
            </div>
            <div>
                <label class="flex items-center gap-3">
                    <input type="checkbox" id="cfg-concorrencia" class="w-5 h-5 text-blue-600 rounded">
                    <span class="text-slate-700 font-medium">Permitir Encaixes (Simultâneos)</span>
                </label>
            </div>
            <button onclick="salvarConfigAPI(this)" class="w-full py-3 btn-primary font-bold shadow-lg shadow-blue-200 btn-anim">Salvar Alterações</button>
        </div>
    </div>

    <!-- Botão Flutuante (FAB) -->
    <div id="main-fab" class="fab btn-anim hidden" onclick="acaoFab()">
        <i data-lucide="plus"></i>
    </div>

    <!-- ================== MODAIS ================== -->

    <!-- 1. MODAL CONFIRMAÇÃO (Genérico) -->
    <div id="modal-confirmacao" class="modal-overlay" style="z-index: 120;">
        <div class="modal-card max-w-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-titulo">Confirmar</h3>
            <p class="text-slate-600 mb-6 text-sm" id="confirm-msg">Tem certeza?</p>
            <div class="flex gap-3">
                <button id="btn-confirm-no" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl btn-anim">Cancelar</button>
                <button id="btn-confirm-yes" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 btn-anim">Sim</button>
            </div>
        </div>
    </div>

    <!-- 2. MODAL AVISO (Genérico) -->
    <div id="modal-aviso" class="modal-overlay" style="z-index: 130;">
        <div class="modal-card max-w-sm text-center">
            <div class="mx-auto w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600">
                <i data-lucide="info" class="w-6 h-6"></i>
            </div>
            <p class="text-slate-800 font-medium mb-6" id="aviso-msg">Mensagem</p>
            <button onclick="fecharModal('modal-aviso')" class="w-full py-3 bg-slate-100 text-slate-700 font-bold rounded-xl btn-anim">OK</button>
        </div>
    </div>

    <!-- 3. MODAL AGENDAMENTO -->
    <div id="modal-agendamento" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Novo Agendamento</h3>
                <button onclick="fecharModal('modal-agendamento')"><i data-lucide="x" class="text-slate-400"></i></button>
            </div>
            <form id="form-agendamento" onsubmit="salvarAgendamentoOtimista(event)">
                <div class="space-y-4">
                    <div id="div-select-prof-modal" class="hidden">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Profissional</label>
                        <select id="select-prof-modal" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Cliente</label>
                        <div class="flex gap-2">
                            <input list="lista-clientes" type="text" id="input-cliente-nome" name="nome_cliente" required placeholder="Buscar cliente..." 
                                class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-base" 
                                onchange="verificarPacoteDisponivel()">
                            <datalist id="lista-clientes"></datalist>
                            <button type="button" onclick="abrirModalCliente()" class="p-3 bg-blue-100 text-blue-600 rounded-xl hover:bg-blue-200 btn-anim">
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Serviço</label>
                        <input list="lista-servicos-datalist" type="text" id="input-servico-nome" name="nome_servico" required placeholder="Buscar serviço..." 
                            class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-base" 
                            onchange="verificarPacoteDisponivel()">
                        <datalist id="lista-servicos-datalist"></datalist>
                    </div>
                    <div id="area-pacote-info" class="hidden bg-green-50 p-3 rounded-xl border border-green-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-green-700 uppercase">Pacote Disponível</p>
                            <p class="text-sm text-green-800">Restam <span id="pacote-saldo">0</span> sessões</p>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="check-usar-pacote" class="w-5 h-5 text-green-600 rounded focus:ring-green-500" checked>
                            <span class="text-sm font-bold text-green-700">Usar</span>
                        </label>
                        <input type="hidden" id="id-pacote-selecionado">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Data</label><input type="date" id="input-data-modal" name="data_agendamento" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Horário</label><input type="time" id="input-hora-modal" name="hora_inicio" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></div>
                    </div>
                </div>
                <button type="submit" id="btn-salvar-agenda" class="w-full mt-6 py-3 btn-primary font-bold btn-anim">Confirmar</button>
            </form>
        </div>
    </div>

    <!-- 4. MODAL EDITAR AGENDAMENTO -->
    <div id="modal-editar-agendamento" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Editar Horário</h3>
                <button onclick="fecharModal('modal-editar-agendamento')"><i data-lucide="x" class="text-slate-400"></i></button>
            </div>
            <form id="form-editar-agendamento" onsubmit="salvarEdicaoAgendamento(event)">
                <input type="hidden" id="edit-agenda-id">
                <div class="space-y-4">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Cliente</p>
                        <p id="edit-agenda-cliente" class="text-lg font-bold text-slate-800"></p>
                        <p id="edit-agenda-servico" class="text-sm text-slate-500"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Nova Data</label><input type="date" id="edit-agenda-data" name="nova_data" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Novo Horário</label><input type="time" id="edit-agenda-hora" name="novo_horario" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></div>
                    </div>
                </div>
                <button type="submit" id="btn-salvar-edicao-agenda" class="w-full mt-6 py-3 btn-primary font-bold btn-anim">Atualizar</button>
            </form>
        </div>
    </div>

    <!-- 5. MODAL VENDER PACOTE -->
    <div id="modal-vender-pacote" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Vender Pacote</h3>
                <button onclick="fecharModal('modal-vender-pacote')"><i data-lucide="x" class="text-slate-400"></i></button>
            </div>
            <form id="form-pacote" onsubmit="salvarVendaPacote(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Cliente</label>
                        <input list="lista-clientes" name="nome_cliente" required placeholder="Buscar cliente..." class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Adicionar Itens</label>
                        <div class="flex gap-2 mb-2">
                            <input list="lista-servicos-datalist" type="text" id="input-servico-pacote-nome" placeholder="Buscar serviço..." class="flex-1 p-2 bg-white border rounded-lg text-sm outline-none text-base">
                            <input type="number" id="qtd-servico-pacote" value="1" min="1" class="w-16 p-2 bg-white border rounded-lg text-sm text-center outline-none text-base">
                            <button type="button" onclick="adicionarItemAoPacote()" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn-anim"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        <div id="lista-itens-pacote" class="space-y-1 mb-2 max-h-40 overflow-y-auto">
                            <p class="text-xs text-slate-400 text-center py-2">Nenhum item adicionado.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Validade</label><input type="date" name="validade" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Valor Total</label><input type="number" step="0.01" id="valor-total-pacote" name="valor_total" required placeholder="0,00" class="w-full p-3 bg-slate-50 border rounded-xl outline-none font-bold text-slate-700 text-lg text-base"></div>
                    </div>
                </div>
                <button type="submit" id="btn-salvar-pacote" class="w-full mt-6 py-3 btn-primary font-bold btn-anim">Confirmar Venda</button>
            </form>
        </div>
    </div>

    <!-- 6. MODAL CLIENTE -->
    <div id="modal-cliente" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">Cadastrar Cliente</h3><button onclick="fecharModal('modal-cliente')"><i data-lucide="x" class="text-slate-400"></i></button></div>
            <form id="form-cliente" onsubmit="salvarNovoCliente(event)">
                <div class="space-y-4">
                    <input type="text" name="nome" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base" placeholder="Nome Completo">
                    <input type="tel" name="whatsapp" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base" placeholder="WhatsApp">
                    <input type="email" name="email" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base" placeholder="Email">
                </div>
                <button type="submit" id="btn-salvar-cliente" class="w-full mt-6 py-3 btn-primary font-bold btn-anim">Salvar e Usar</button>
            </form>
        </div>
    </div>

    <!-- 7. MODAL SERVICO (CRIAR) -->
    <div id="modal-servico" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">Novo Serviço</h3><button onclick="fecharModal('modal-servico')"><i data-lucide="x" class="text-slate-400"></i></button></div>
            <form id="form-servico" onsubmit="salvarNovoServico(event)">
                <div class="space-y-4">
                    <input type="text" name="nome_servico" required placeholder="Nome do Serviço" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" step="0.01" name="valor_unitario" placeholder="Preço" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                        <input type="number" name="duracao_minutos" placeholder="Minutos" required value="60" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Imagem</label><input type="file" id="input-imagem-servico" accept="image/*" class="w-full text-sm"></div>
                    <div><label class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg cursor-pointer"><input type="checkbox" id="check-online-booking" class="w-5 h-5 text-blue-600 rounded"><span class="text-sm font-bold text-slate-700">Online</span></label></div>
                    <div><p class="text-xs font-bold text-slate-500 mb-2">Cor</p><div id="color-picker-container" class="flex justify-between"></div><input type="hidden" name="cor_hex" id="input-cor-selecionada" value="#3b82f6"></div>
                </div>
                <button type="submit" id="btn-salvar-servico" class="w-full mt-6 py-3 btn-primary font-bold btn-anim">Salvar</button>
            </form>
        </div>
    </div>

    <!-- 8. MODAL SERVICO (EDITAR) -->
    <div id="modal-editar-servico" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">Editar Serviço</h3><button onclick="fecharModal('modal-editar-servico')"><i data-lucide="x" class="text-slate-400"></i></button></div>
            <form id="form-editar-servico" onsubmit="salvarEdicaoServico(event)">
                <input type="hidden" name="id_servico" id="edit-id-servico">
                <div class="space-y-4">
                    <input type="text" name="nome_servico" id="edit-nome-servico" required placeholder="Nome do Serviço" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    <div class="grid grid-cols-2 gap-3"><input type="number" step="0.01" name="valor_unitario" id="edit-valor-servico" placeholder="Preço" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"><input type="number" name="duracao_minutos" id="edit-duracao-servico" placeholder="Minutos" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nova Imagem</label><input type="file" id="edit-input-imagem-servico" accept="image/*" class="w-full text-sm"></div>
                    <div><label class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg cursor-pointer"><input type="checkbox" id="edit-check-online-booking" class="w-5 h-5 text-blue-600 rounded"><span class="text-sm font-bold text-slate-700">Online</span></label></div>
                    <div><p class="text-xs font-bold text-slate-500 mb-2">Cor</p><div id="edit-color-picker-container" class="flex justify-between"></div><input type="hidden" name="cor_hex" id="edit-input-cor-selecionada"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="excluirServicoViaModal()" class="flex-1 py-3 text-red-600 font-bold hover:bg-red-50 rounded-xl btn-anim border border-red-200">Excluir</button>
                    <button type="submit" id="btn-salvar-edicao-servico" class="flex-1 py-3 btn-primary font-bold btn-anim">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 9. MODAL DETALHES PACOTE -->
    <div id="modal-detalhes-pacote" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-slate-800">Detalhes do Pacote</h3><button onclick="fecharModal('modal-detalhes-pacote')"><i data-lucide="x" class="text-slate-400"></i></button></div>
            <div class="modal-tabs"><div class="modal-tab active" onclick="switchModalTab('saldos')">Saldos</div><div class="modal-tab" onclick="switchModalTab('historico')">Histórico</div></div>
            <div id="tab-modal-saldos" class="modal-tab-content active space-y-3 max-h-60 overflow-y-auto"></div>
            <div id="tab-modal-historico" class="modal-tab-content space-y-2 max-h-60 overflow-y-auto"><p class="text-center text-slate-400 text-sm">Carregando...</p></div>
        </div>
    </div>

    <!-- 10. MODAL NOVO USUÁRIO -->
    <div id="modal-usuario" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800">Novo Profissional</h3><button onclick="fecharModal('modal-usuario')"><i data-lucide="x" class="text-slate-400"></i></button></div>
            <form id="form-usuario" onsubmit="salvarUsuario(event)">
                <div class="space-y-4">
                    <input type="text" name="nome" required placeholder="Nome" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    <input type="email" name="email" required placeholder="Email" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    <input type="text" name="senha" required placeholder="Senha" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base">
                    <select name="nivel" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-base"><option value="padrao">Padrão</option><option value="admin">Admin</option></select>
                </div>
                <button type="submit" id="btn-salvar-usuario" class="w-full mt-6 py-3 btn-primary font-bold btn-anim">Salvar</button>
            </form>
        </div>
    </div>

    <!-- 11. MODAL DETALHES AGENDAMENTO -->
    <div id="modal-detalhes" class="modal-overlay">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Detalhes</h3>
                <button onclick="fecharModal('modal-detalhes')" class="p-2 -mr-2 text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="detalhes-conteudo" class="mb-4"></div>
            <div class="flex flex-col gap-3">
                <button id="btn-editar-horario" onclick="abrirModalEditarAgendamento()" class="w-full py-3 bg-slate-100 text-slate-700 font-bold rounded-xl text-sm hover:bg-slate-200 btn-anim flex items-center justify-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> Editar Horário</button>
                <button id="btn-confirmar" onclick="prepararStatus('Confirmado', this)" class="p-3 bg-blue-50 text-blue-700 font-bold rounded-xl text-sm border border-blue-100 flex items-center justify-center gap-2 btn-anim"><i data-lucide="thumbs-up" class="w-4 h-4"></i> Confirmar Presença</button>
                <button id="btn-concluir" onclick="prepararStatus('Concluido', this)" class="p-3 bg-slate-100 text-slate-600 font-bold rounded-xl text-sm flex items-center justify-center gap-2 btn-anim"><i data-lucide="check" class="w-4 h-4"></i> Concluir (Realizado)</button>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button id="btn-cancelar" onclick="prepararStatus('Cancelado', this)" class="p-3 bg-yellow-100 text-yellow-700 font-bold rounded-xl text-sm hover:bg-yellow-200 btn-anim">Cancelar Agendamento</button>
                    <button id="btn-excluir" onclick="prepararStatus('Excluir', this)" class="p-3 bg-red-100 text-red-700 font-bold rounded-xl text-sm hover:bg-red-200 btn-anim">Apagar Agendamento</button>
                </div>
            </div>
            <input type="hidden" id="id-agendamento-ativo">
            <input type="hidden" id="id-pacote-agendamento-ativo">
        </div>
    </div>

    <!-- NAVBAR INFERIOR -->
    <nav id="bottom-nav" class="bottom-nav hidden">
        <div class="nav-item active" onclick="switchTab('agenda', this)"><i data-lucide="calendar"></i><span>Agenda</span></div>
        <div class="nav-item admin-only" onclick="switchTab('servicos', this)"><i data-lucide="sparkles"></i><span>Serviços</span></div>
        <div class="nav-item admin-only" onclick="switchTab('pacotes', this)"><i data-lucide="package"></i><span>Pacotes</span></div>
        <div class="nav-item admin-only" onclick="switchTab('equipa', this)"><i data-lucide="users"></i><span>Equipa</span></div>
        <div class="nav-item admin-only" onclick="switchTab('config', this)"><i data-lucide="settings-2"></i><span>Config</span></div>
    </nav>

    <!-- SCRIPTS -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxgSkDYPhTJerGbFsubJE9b_xuwCM6KnAtWh5gFF3WEIEGFWf-SIHd_iWUH3J4JitWUHA/exec';
        const PALETA_CORES = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7'];
        const IMGBB_API_KEY = 'fa0265b3bfc740c1eb09a7e4d6ec493a';
        const CACHE_KEY_PREFIX = 'minhaAgenda_';

        let currentUser = null;
        let currentProfId = null;
        let dataAtual = new Date();
        let servicosCache = [], agendamentosCache = [], clientesCache = [], pacotesCache = [], usuariosCache = [];
        let itensPacoteTemp = [];
        let abaAtiva = 'agenda';
        let config = { abertura: '08:00', fechamento: '19:00', intervalo_minutos: 60, permite_encaixe: false };
        let agendamentosRaw = [];
        let isSyncing = false;
        let pollingInterval = null;

        // --- CACHE LOCAL ---
        function saveToCache(key, data) { localStorage.setItem(CACHE_KEY_PREFIX + key, JSON.stringify(data)); }
        function getFromCache(key) { const data = localStorage.getItem(CACHE_KEY_PREFIX + key); return data ? JSON.parse(data) : null; }

        // --- ACTIONS & NAV ---
        function switchTab(t, el) { abaAtiva = t; document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); document.getElementById('main-fab').style.display = t==='config'?'none':'flex'; if (t === 'pacotes') carregarPacotes(); }
        function acaoFab() { if(abaAtiva==='servicos') abrirModalServico(); else if(abaAtiva==='agenda') abrirModalAgendamento(); else if(abaAtiva==='pacotes') abrirModalVenderPacote(); else if(abaAtiva==='equipa') abrirModalUsuario(); }
        
        function mudarDia(d) { 
            dataAtual.setDate(dataAtual.getDate()+d); 
            atualizarDataEPainel(); 
        }
        
        function atualizarDataEPainel() {
            document.getElementById('data-picker').value = dataAtual.toISOString().split('T')[0]; 
            document.getElementById('dia-semana-display').innerText = dataAtual.toLocaleDateString('pt-PT', {weekday:'long', day:'numeric', month:'long'});
            atualizarAgendaVisual(); 
        }

        function renderizarColorPicker() { const c=document.getElementById('color-picker-container'); c.innerHTML=''; PALETA_CORES.forEach((cor,i)=>{const d=document.createElement('div');d.className=`color-option ${i===4?'selected':''}`;d.style.backgroundColor=cor;d.onclick=()=>{document.querySelectorAll('.color-option').forEach(el=>el.classList.remove('selected'));d.classList.add('selected');document.getElementById('input-cor-selecionada').value=cor};c.appendChild(d)})}
        function renderizarColorPickerEdicao() { const c=document.getElementById('edit-color-picker-container'); c.innerHTML=''; PALETA_CORES.forEach((cor,i)=>{const d=document.createElement('div');d.className=`color-option ${i===4?'selected':''}`;d.style.backgroundColor=cor;d.onclick=()=>{document.querySelectorAll('#edit-color-picker-container .color-option').forEach(el=>el.classList.remove('selected'));d.classList.add('selected');document.getElementById('edit-input-cor-selecionada').value=cor};c.appendChild(d)})}
        async function testarConexao() { try{const r=await fetch(`${API_URL}?action=testConnection`);const d=await r.json();if(d.status==='sucesso')document.getElementById('connection-status').className='w-2.5 h-2.5 rounded-full bg-green-500'}catch(e){document.getElementById('connection-status').className='w-2.5 h-2.5 rounded-full bg-red-500'}}
        
        function formatarDataBr(s) { 
            if(!s) return ''; 
            if(s.includes('T')) return new Date(s).toLocaleDateString('pt-BR'); return s.split('-').reverse().join('/'); 
        }
        function excluirServicoViaModal(){ const id=document.getElementById('edit-id-servico').value; mostrarConfirmacao('Excluir Serviço', 'Tem certeza?', async () => { try { await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'deleteServico', id_servico: id})}); fecharModal('modal-confirmacao'); fecharModal('modal-editar-servico'); carregarServicos(); } catch(e) { mostrarAviso('Erro'); } }); }
        function mudarProfissionalAgenda() { currentProfId = document.getElementById('select-profissional-agenda').value; atualizarAgendaVisual(); }
        function renderizarListaUsuarios() { const container = document.getElementById('lista-usuarios'); container.innerHTML = ''; usuariosCache.forEach(u => { container.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600">${u.nome.charAt(0)}</div><div><h4 class="font-bold text-slate-800">${u.nome}</h4><p class="text-xs text-slate-400 capitalize">${u.nivel}</p></div></div></div>`; }); }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const savedUser = localStorage.getItem('minhaAgendaUser') || sessionStorage.getItem('minhaAgendaUser');
            if(savedUser) { currentUser = JSON.parse(savedUser); iniciarApp(); }
            
            document.getElementById('data-picker').addEventListener('change', (e) => { 
                const p=e.target.value.split('-'); 
                dataAtual=new Date(p[0],p[1]-1,p[2]); 
                atualizarDataEPainel(); 
            });

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        fecharModal(overlay.id);
                    }
                });
            });

            window.addEventListener('beforeunload', function (e) {
                if (isSyncing) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        // ============ CORE ============
        async function fazerLogin(e) {
            e.preventDefault(); const btn = document.getElementById('btn-login'); setLoading(btn, true, 'Entrar'); const email = document.getElementById('login-email').value; const senha = document.getElementById('login-senha').value; const manter = document.getElementById('login-manter').checked;
            try { const r = await fetch(`${API_URL}?action=login&email=${email}&senha=${senha}`); const res = await r.json(); if (res.status === 'sucesso') { currentUser = res.usuario; if(manter) localStorage.setItem('minhaAgendaUser', JSON.stringify(currentUser)); else sessionStorage.setItem('minhaAgendaUser', JSON.stringify(currentUser)); iniciarApp(); } else { mostrarAviso(res.mensagem); setLoading(btn, false, 'Entrar'); } } catch(err) { mostrarAviso('Erro de conexão'); setLoading(btn, false, 'Entrar'); }
        }
        function logout() { localStorage.removeItem('minhaAgendaUser'); sessionStorage.removeItem('minhaAgendaUser'); if(pollingInterval) clearInterval(pollingInterval); location.reload(); }
        function iniciarApp() {
            document.getElementById('login-screen').style.display = 'none'; document.getElementById('app-header').classList.remove('hidden'); document.getElementById('app-header').classList.add('flex'); document.getElementById('bottom-nav').classList.remove('hidden'); document.getElementById('bottom-nav').classList.add('flex'); document.getElementById('main-fab').classList.remove('hidden'); document.getElementById('main-fab').classList.add('flex'); document.getElementById('user-name-display').innerText = `Olá, ${currentUser.nome}`; document.getElementById('tab-agenda').classList.add('active');
            currentProfId = String(currentUser.id_usuario); if (currentUser.nivel !== 'admin') { document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none'); } else { document.getElementById('select-profissional-agenda').classList.remove('hidden'); }
            renderizarColorPicker(); renderizarColorPickerEdicao(); carregarDoCache(); sincronizarDadosAPI(); pollingInterval = setInterval(() => recarregarAgendaComFiltro(true), 15000);
        }
        
        function carregarDoCache() {
            const cachedServicos = getFromCache('servicos');
            const cachedConfig = getFromCache('config');
            const cachedUsuarios = getFromCache('usuarios');
            const cachedAgendamentos = getFromCache('agendamentos');
            const cachedClientes = getFromCache('clientes');
            const cachedPacotes = getFromCache('pacotes');

            if(cachedServicos) { servicosCache = cachedServicos; renderizarListaServicos(); atualizarDatalistServicos(); }
            if(cachedConfig) { config = cachedConfig; }
            if(cachedUsuarios) { usuariosCache = cachedUsuarios; popularSelectsUsuarios(); renderizarListaUsuarios(); }
            
            // AGORA CARREGA TUDO DO CACHE
            if(cachedAgendamentos) { agendamentosRaw = cachedAgendamentos; }
            if(cachedClientes) { clientesCache = cachedClientes; atualizarDatalistClientes(); }
            if(cachedPacotes) { pacotesCache = cachedPacotes; }
            
            atualizarDataEPainel();
        }

        async function sincronizarDadosAPI() {
            const hasData = document.querySelectorAll('.time-slot').length > 0; const container = document.getElementById('agenda-timeline'); 
            // Se não tem dados visuais (nem do cache), mostra loading inicial. Senão, background.
            if(!hasData && agendamentosRaw.length === 0) { container.innerHTML = '<div class="p-10 text-center text-slate-400"><div class="spinner spinner-dark mx-auto mb-2 border-slate-300 border-t-blue-500"></div><p>A carregar agenda...</p></div>'; } else { showSyncIndicator(true); }
            try {
                const fetchSafe = async (action) => { try { const r = await fetch(`${API_URL}?action=${action}`); return await r.json(); } catch(e) { console.error(`Erro ${action}`, e); return []; } };
                const [resConfig, resServicos, resClientes, resPacotes, resAgendamentos, resUsuarios] = await Promise.all([ fetchSafe('getConfig'), fetchSafe('getServicos'), fetchSafe('getClientes'), fetchSafe('getPacotes'), fetchSafe('getAgendamentos'), currentUser.nivel === 'admin' ? fetchSafe('getUsuarios') : Promise.resolve([]) ]);
                if(resConfig && resConfig.abertura) { config = resConfig; saveToCache('config', config); }
                servicosCache = Array.isArray(resServicos) ? resServicos : []; saveToCache('servicos', servicosCache);
                clientesCache = Array.isArray(resClientes) ? resClientes : []; saveToCache('clientes', clientesCache);
                pacotesCache = Array.isArray(resPacotes) ? resPacotes : []; saveToCache('pacotes', pacotesCache);
                agendamentosRaw = Array.isArray(resAgendamentos) ? resAgendamentos : []; saveToCache('agendamentos', agendamentosRaw);
                usuariosCache = Array.isArray(resUsuarios) ? resUsuarios : []; if(usuariosCache.length > 0) saveToCache('usuarios', usuariosCache);
                atualizarDataEPainel(); atualizarDatalistServicos(); atualizarDatalistClientes(); renderizarListaServicos(); if (currentUser.nivel === 'admin') { renderizarListaPacotes(); renderizarListaUsuarios(); popularSelectsUsuarios(); }
                atualizarAgendaVisual(); showSyncIndicator(false);
            } catch (error) { console.error("Erro sincronização", error); if(!hasData) container.innerHTML = '<p class="text-center text-red-400 text-sm">Erro de conexão.</p>'; showSyncIndicator(false); }
        }

        function atualizarAgendaVisual() {
            if (!agendamentosRaw) return; const filtroId = String(currentProfId);
            agendamentosCache = agendamentosRaw.filter(a => { const aId = a.id_profissional ? String(a.id_profissional) : ''; if (currentUser.nivel === 'admin') { return aId === filtroId; } else { return aId === String(currentUser.id_usuario); } });
            renderizarGrade();
        }

        function recarregarAgendaComFiltro(silencioso = false) {
            if(!silencioso) showSyncIndicator(true);
            const modalIdInput = document.getElementById('id-agendamento-ativo'); const activeTempId = (modalIdInput && String(modalIdInput.value).startsWith('temp_')) ? modalIdInput.value : null; let tempItem = null; if(activeTempId) { tempItem = agendamentosRaw.find(a => a.id_agendamento === activeTempId); }
            fetch(`${API_URL}?action=getAgendamentos`).then(r => r.json()).then(dados => {
                const novosAgendamentos = Array.isArray(dados) ? dados : [];
                if (activeTempId && tempItem) {
                    const realItem = novosAgendamentos.find(a => a.data_agendamento === tempItem.data_agendamento && a.hora_inicio === tempItem.hora_inicio && (a.nome_cliente === tempItem.nome_cliente || (a.observacoes && a.observacoes.includes(tempItem.nome_cliente))) );
                    if (realItem) { 
                        const idxLocal = agendamentosRaw.findIndex(a => a.id_agendamento === activeTempId); if(idxLocal !== -1) { agendamentosRaw[idxLocal] = realItem; }
                        modalIdInput.value = realItem.id_agendamento; abrirModalDetalhes(realItem.id_agendamento); 
                    } else { if(document.getElementById('modal-detalhes').classList.contains('open')) { fecharModal('modal-detalhes'); } }
                }
                agendamentosRaw = novosAgendamentos; saveToCache('agendamentos', agendamentosRaw); atualizarAgendaVisual(); showSyncIndicator(false);
            }).catch((e) => { console.error(e); showSyncIndicator(false); });
        }
        
        function showSyncIndicator(show) { isSyncing = show; document.getElementById('sync-indicator').style.display = show ? 'flex' : 'none'; }

        function renderizarGrade() {
            const container = document.getElementById('agenda-timeline'); if(!container) return; container.innerHTML = '';
            const [hA, mA] = config.abertura.split(':').map(Number); const [hF, mF] = config.fechamento.split(':').map(Number); const startMin = hA*60 + mA; const endMin = hF*60 + mF; const interval = parseInt(config.intervalo_minutos) || 60; const dateIso = dataAtual.toISOString().split('T')[0];
            for(let m = startMin; m < endMin; m += interval) { const hSlot = Math.floor(m/60); const mSlot = m % 60; const timeStr = `${String(hSlot).padStart(2,'0')}:${String(mSlot).padStart(2,'0')}`; const div = document.createElement('div'); div.className = 'time-slot'; div.style.height = '80px'; div.innerHTML = `<div class="time-label">${timeStr}</div><div class="slot-content" id="slot-${m}"><div class="slot-livre-area" onclick="abrirModalAgendamento('${timeStr}')"></div></div>`; container.appendChild(div); }
            const events = agendamentosCache.filter(a => a.data_agendamento === dateIso && a.hora_inicio).map(a => { const [h, m] = a.hora_inicio.split(':').map(Number); const start = h*60 + m; const svc = servicosCache.find(s => String(s.id_servico) === String(a.id_servico)); const dur = svc ? parseInt(svc.duracao_minutos) : 60; return { ...a, start, end: start + dur, dur, svc }; }).sort((a,b) => a.start - b.start);
            let groups = []; let lastEnd = -1; events.forEach(ev => { if(ev.start >= lastEnd) { groups.push([ev]); lastEnd = ev.end; } else { groups[groups.length-1].push(ev); if(ev.end > lastEnd) lastEnd = ev.end; } });
            groups.forEach(group => { const width = 100 / group.length; group.forEach((ev, idx) => { if(ev.start < startMin || ev.start >= endMin) return; const offset = (ev.start - startMin) % interval; const slotBase = ev.start - offset; const slotEl = document.getElementById(`slot-${slotBase}`); if(!slotEl) return; const height = (ev.dur / interval) * 80; const top = (offset / interval) * 80; const left = idx * width; const card = document.createElement('div'); card.className = 'event-card'; card.style.top = `${top + 2}px`; card.style.height = `calc(${height}px - 4px)`; card.style.left = `calc(${left}% + 2px)`; card.style.width = `calc(${width}% - 4px)`; const color = getCorServico(ev.svc); card.style.backgroundColor = hexToRgba(color, 0.15); card.style.borderLeftColor = color; card.style.color = '#1e293b'; let statusIcon = ''; if(ev.status === 'Confirmado') { statusIcon = '<div class="absolute top-1 right-1 bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center shadow-sm"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>'; card.classList.add('status-confirmado'); } else if (ev.status === 'Concluido') card.classList.add('status-concluido'); else if (ev.status === 'Cancelado') card.classList.add('status-cancelado'); else card.style.borderLeftColor = color; card.onclick = (e) => { e.stopPropagation(); abrirModalDetalhes(ev.id_agendamento); }; const name = ev.nome_cliente || ev.observacoes || 'Cliente'; card.innerHTML = `${statusIcon}<div style="width:90%" class="font-bold truncate text-[10px]">${name}</div>${width > 25 ? `<div class="text-xs truncate">${ev.hora_inicio} • ${ev.svc ? ev.svc.nome_servico : 'Serviço'}</div>` : ''}`; slotEl.appendChild(card); }); });
        }

        async function salvarAgendamentoOtimista(e) { 
            e.preventDefault(); const f = e.target; const nomeCliente = f.nome_cliente.value; const nomeServico = f.nome_servico.value; const dataAg = f.data_agendamento.value; const horaIni = f.hora_inicio.value;
            const cliente = clientesCache.find(c => c.nome === nomeCliente); const servico = servicosCache.find(s => s.nome_servico.toLowerCase() === nomeServico.toLowerCase()); 
            if(!servico) { mostrarAviso('Serviço não encontrado.'); return; }
            fecharModal('modal-agendamento');
            const tempId = 'temp_' + Date.now(); const profId = (currentUser.nivel === 'admin' && document.getElementById('select-prof-modal').value) ? document.getElementById('select-prof-modal').value : currentUser.id_usuario;
            const novoItem = { id_agendamento: tempId, id_cliente: cliente ? cliente.id_cliente : 'novo', id_servico: servico.id_servico, data_agendamento: dataAg, hora_inicio: horaIni, hora_fim: calcularHoraFim(horaIni, servico.duracao_minutos), status: 'Agendado', nome_cliente: nomeCliente, id_profissional: profId, id_pacote_usado: document.getElementById('check-usar-pacote').checked ? document.getElementById('id-pacote-selecionado').value : '' };
            agendamentosRaw.push(novoItem); saveToCache('agendamentos', agendamentosRaw); atualizarAgendaVisual();
            showSyncIndicator(true);
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'createAgendamento', nome_cliente: nomeCliente, id_cliente: novoItem.id_cliente, id_servico: novoItem.id_servico, data_agendamento: dataAg, hora_inicio: horaIni, usar_pacote_id: novoItem.id_pacote_usado, id_profissional: profId }) });
                const data = await res.json();
                if (data.status === 'sucesso' && data.id_agendamento) { const idx = agendamentosRaw.findIndex(a => a.id_agendamento === tempId); if (idx !== -1) { agendamentosRaw[idx].id_agendamento = data.id_agendamento; if (data.id_cliente) agendamentosRaw[idx].id_cliente = data.id_cliente; saveToCache('agendamentos', agendamentosRaw); atualizarAgendaVisual(); const modalIdInput = document.getElementById('id-agendamento-ativo'); if(modalIdInput && modalIdInput.value === tempId) { modalIdInput.value = data.id_agendamento; abrirModalDetalhes(data.id_agendamento); } } }
                showSyncIndicator(false);
            } catch (err) { console.error("Erro ao salvar", err); agendamentosRaw = agendamentosRaw.filter(a => a.id_agendamento !== tempId); saveToCache('agendamentos', agendamentosRaw); atualizarAgendaVisual(); mostrarAviso('Falha ao salvar agendamento. Tente novamente.'); showSyncIndicator(false); } f.reset();
        }

        // Restante das funções de UI e Helpers mantidas iguais...
        function prepararStatus(st, btnEl) { const id = document.getElementById('id-agendamento-ativo').value; const idPacote = document.getElementById('id-pacote-agendamento-ativo').value; const contentBotao = btnEl ? btnEl.innerHTML : '';
            if(String(id).startsWith('temp_')) { if(btnEl) { setLoading(btnEl, true, 'Sincronizando...'); setTimeout(() => { setLoading(btnEl, false, contentBotao); }, 2000); } return; }
            if (st === 'Excluir') { mostrarConfirmacao('Apagar Agendamento', 'Tem certeza? Saldo será devolvido.', () => executarMudancaStatusOtimista(id, st, true)); 
            } else if (st === 'Cancelado') { if(idPacote) { mostrarConfirmacao('Cancelar com Pacote', 'Devolver crédito ao cliente?', () => executarMudancaStatusOtimista(id, st, true), () => executarMudancaStatusOtimista(id, st, false), 'Sim, Devolver', 'Não, Debitar' ); } else { mostrarConfirmacao('Cancelar Agendamento', 'Tem certeza que deseja cancelar?', () => executarMudancaStatusOtimista(id, st, false)); } 
            } else if (st === 'Confirmado') { executarMudancaStatusOtimista(id, st, false); } else { executarMudancaStatusOtimista(id, st, false); } 
        }

        async function executarMudancaStatusOtimista(id, st, devolver) {
            fecharModal('modal-confirmacao'); fecharModal('modal-detalhes');
            const index = agendamentosRaw.findIndex(a => a.id_agendamento === id); if(index === -1) return; const backup = { ...agendamentosRaw[index] };
            if(st === 'Excluir') { agendamentosRaw.splice(index, 1); } else { agendamentosRaw[index].status = st; } saveToCache('agendamentos', agendamentosRaw); atualizarAgendaVisual();
            showSyncIndicator(true);
            try { const res = await fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'updateStatusAgendamento', id_agendamento:id, novo_status:st, devolver_credito: devolver }) }); const data = await res.json(); if (data.status !== 'sucesso') { throw new Error(data.mensagem || 'Erro no servidor'); } if(devolver) setTimeout(carregarPacotes, 1000); showSyncIndicator(false); } catch(e) { console.error("Erro update status", e); if(st === 'Excluir') agendamentosRaw.splice(index, 0, backup); else agendamentosRaw[index] = backup; saveToCache('agendamentos', agendamentosRaw); atualizarAgendaVisual(); mostrarAviso('Erro de conexão. Alteração não salva.'); showSyncIndicator(false); }
        }
        function calcularHoraFim(inicio, duracao) { const [h, m] = inicio.split(':').map(Number); const fimMin = h * 60 + m + parseInt(duracao); return `${String(Math.floor(fimMin / 60)).padStart(2,'0')}:${String(fimMin % 60).padStart(2,'0')}`; }
        function mostrarAviso(msg) { document.getElementById('aviso-msg').innerText = msg; document.getElementById('modal-aviso').classList.add('open'); }
        function mostrarConfirmacao(t, m, yesCb, noCb, yesTxt='Sim', noTxt='Cancelar') { document.getElementById('confirm-titulo').innerText = t; document.getElementById('confirm-msg').innerText = m; const oldY = document.getElementById('btn-confirm-yes'); const oldN = document.getElementById('btn-confirm-no'); const newY = oldY.cloneNode(true); const newN = oldN.cloneNode(true); newY.innerText = yesTxt; newN.innerText = noTxt; newY.disabled = false; newN.disabled = false; oldY.parentNode.replaceChild(newY, oldY); oldN.parentNode.replaceChild(newN, oldN); newY.onclick = () => { yesCb(); }; newN.onclick = () => { fecharModal('modal-confirmacao'); if(noCb) noCb(); }; document.getElementById('modal-confirmacao').classList.add('open'); }
        function setLoading(btn, l, t) { btn.disabled = l; if (l) { const isDarkBg = btn.classList.contains('btn-primary') || btn.classList.contains('bg-blue-600') || btn.classList.contains('bg-red-600'); const spinnerType = isDarkBg ? 'spinner' : 'spinner spinner-dark'; btn.innerHTML = `<span class="${spinnerType}"></span>`; } else { btn.innerHTML = t; } }
        
        function getCorServico(s) { return s ? (s.cor_hex || s.cor || '#3b82f6') : '#3b82f6'; }
        function hexToRgba(hex, a) { if(!hex) return `rgba(59,130,246,${a})`; hex = hex.replace('#',''); return `rgba(${parseInt(hex.substring(0,2),16)},${parseInt(hex.substring(2,4),16)},${parseInt(hex.substring(4,6),16)},${a})`; }
        function hexToRgb(hex) { var r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? parseInt(r[1],16)+", "+parseInt(r[2],16)+", "+parseInt(r[3],16) : "59,130,246"; }
        function atualizarDatalistServicos() { const dl = document.getElementById('lista-servicos-datalist'); if(dl) { dl.innerHTML = ''; servicosCache.forEach(i=>{ const o=document.createElement('option'); o.value=i.nome_servico; dl.appendChild(o); }); } }
        function atualizarDatalistClientes() { const dl = document.getElementById('lista-clientes'); if(dl) { dl.innerHTML = ''; clientesCache.forEach(c=>{ const o=document.createElement('option'); o.value=c.nome; dl.appendChild(o); }); } }
        function popularSelectsUsuarios() { const selectHeader = document.getElementById('select-profissional-agenda'); selectHeader.innerHTML = ''; const optMe = document.createElement('option'); optMe.value = currentUser.id_usuario; optMe.text = "Minha Agenda"; selectHeader.appendChild(optMe); usuariosCache.forEach(u => { if (u.id_usuario !== currentUser.id_usuario) { const opt = document.createElement('option'); opt.value = u.id_usuario; opt.text = u.nome; selectHeader.appendChild(opt); } }); const selectModal = document.getElementById('select-prof-modal'); selectModal.innerHTML = ''; const optMeModal = document.createElement('option'); optMeModal.value = currentUser.id_usuario; optMeModal.text = currentUser.nome + " (Eu)"; selectModal.appendChild(optMeModal); usuariosCache.forEach(u => { if (u.id_usuario !== currentUser.id_usuario) { const opt = document.createElement('option'); opt.value = u.id_usuario; opt.text = u.nome; selectModal.appendChild(opt); } }); }
        function fecharModal(id) { document.getElementById(id).classList.remove('open'); if(id==='modal-agendamento') document.getElementById('area-pacote-info')?.classList.add('hidden'); }
        function abrirModalAgendamento(h) { document.getElementById('modal-agendamento').classList.add('open'); document.getElementById('input-data-modal').value = dataAtual.toISOString().split('T')[0]; if(h) document.getElementById('input-hora-modal').value = h; if(currentUser.nivel==='admin'){ document.getElementById('div-select-prof-modal').classList.remove('hidden'); document.getElementById('select-prof-modal').value=currentProfId; } else { document.getElementById('div-select-prof-modal').classList.add('hidden'); } }
        function abrirModalCliente() { document.getElementById('modal-cliente').classList.add('open'); }
        function abrirModalServico() { document.getElementById('modal-servico').classList.add('open'); }
        function abrirModalVenderPacote() { itensPacoteTemp=[]; atualizarListaVisualPacote(); document.getElementById('input-servico-pacote-nome').value=''; document.getElementById('valor-total-pacote').value=''; document.getElementById('modal-vender-pacote').classList.add('open'); }
        function abrirModalUsuario() { document.getElementById('modal-usuario').classList.add('open'); }
        function abrirModalEditarAgendamento() { const id=document.getElementById('id-agendamento-ativo').value; const ag=agendamentosCache.find(x=>x.id_agendamento===id); if(!ag)return; fecharModal('modal-detalhes'); document.getElementById('edit-agenda-id').value=id; document.getElementById('edit-agenda-cliente').innerText=ag.nome_cliente; const svc=servicosCache.find(s=>String(s.id_servico)===String(ag.id_servico)); document.getElementById('edit-agenda-servico').innerText=svc?svc.nome_servico:'Serviço'; document.getElementById('edit-agenda-data').value=ag.data_agendamento; document.getElementById('edit-agenda-hora').value=ag.hora_inicio; document.getElementById('modal-editar-agendamento').classList.add('open'); }
        function abrirModalEditarServico(id) { const s=servicosCache.find(x=>x.id_servico===id); if(!s)return; document.getElementById('edit-id-servico').value=s.id_servico; document.getElementById('edit-nome-servico').value=s.nome_servico; document.getElementById('edit-valor-servico').value=s.valor_unitario; document.getElementById('edit-duracao-servico').value=s.duracao_minutos; document.getElementById('edit-check-online-booking').checked=String(s.agendamento_online)==='true'; document.getElementById('edit-input-cor-selecionada').value=getCorServico(s); renderizarColorPickerEdicao(); document.getElementById('modal-editar-servico').classList.add('open'); }
        
        function abrirModalDetalhes(id) { 
            const ag = agendamentosCache.find(a => a.id_agendamento === id); if(!ag) return; 
            resetarBotoesModal();
            document.getElementById('id-agendamento-ativo').value = id; 
            const idPacote = ag.id_pacote_usado || ag.id_pacote || ''; 
            document.getElementById('id-pacote-agendamento-ativo').value = idPacote;
            const servico = servicosCache.find(s => String(s.id_servico) === String(ag.id_servico)); 
            const nomeCliente = ag.nome_cliente || ag.observacoes || 'Cliente'; 
            let htmlPacote = idPacote ? '<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded ml-2">Pacote</span>' : '';
            const isConcluido = ag.status === 'Concluido';
            document.getElementById('btn-editar-horario').style.display = isConcluido ? 'none' : 'flex';
            document.getElementById('btn-cancelar').style.display = isConcluido ? 'none' : 'block';
            const btnConfirmar = document.getElementById('btn-confirmar');
            const nBtn = btnConfirmar.cloneNode(true);
            btnConfirmar.parentNode.replaceChild(nBtn, btnConfirmar);
            nBtn.onclick = () => prepararStatus('Confirmado', nBtn);
            if(String(id).startsWith('temp_')) { nBtn.disabled = true; nBtn.innerText = "Sincronizando..."; document.getElementById('btn-concluir').disabled = true; document.getElementById('btn-cancelar').disabled = true; document.getElementById('btn-excluir').disabled = true; }
            if (isConcluido) { nBtn.style.display = 'none'; document.getElementById('btn-concluir').style.display = 'none'; } else { if (ag.status === 'Confirmado') { nBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Já Confirmado'; nBtn.className = "p-3 bg-green-100 text-green-700 font-bold rounded-xl text-sm border border-green-200 flex items-center justify-center gap-2 cursor-default"; nBtn.onclick = null; nBtn.disabled = true; nBtn.style.display = 'flex'; } else if (ag.status === 'Cancelado') { nBtn.style.display = 'none'; } else { nBtn.style.display = 'flex'; } document.getElementById('btn-concluir').style.display = 'flex'; }
            document.getElementById('detalhes-conteudo').innerHTML = `<div class="p-3 bg-slate-50 rounded-xl border border-slate-100"><p class="text-xs font-bold text-slate-400 uppercase">Cliente</p><p class="font-bold text-slate-800 text-lg mb-2">${nomeCliente}</p><p class="text-xs font-bold text-slate-400 uppercase">Serviço</p><p class="text-slate-700 mb-2 flex items-center">${servico ? servico.nome_servico : '...'} ${htmlPacote}</p><p class="text-xs font-bold text-slate-400 uppercase">Horário</p><p class="font-mono text-slate-700">${ag.hora_inicio} - ${ag.hora_fim}</p><p class="mt-2 text-xs font-bold uppercase status-text">${ag.status||'Agendado'}</p></div>`; 
            document.getElementById('modal-detalhes').classList.add('open'); 
            lucide.createIcons(); 
        }

        // Restante das funções de UI e Helpers mantidas iguais...
        async function salvarVendaPacote(e) { e.preventDefault(); const btn=document.getElementById('btn-salvar-pacote'); const originalText = btn.innerText; setLoading(btn, true, originalText); const f=e.target; if (itensPacoteTemp.length === 0) { mostrarAviso('Adicione serviços.'); setLoading(btn, false, originalText); return; } const cliente = clientesCache.find(c => c.nome === f.nome_cliente.value); if(!cliente) { mostrarAviso('Cliente inválido.'); setLoading(btn, false, originalText); return; } try { await fetch(API_URL, {method:'POST', body:JSON.stringify({ action:'createPacote', id_cliente: cliente.id_cliente, nome_cliente: cliente.nome, itens: itensPacoteTemp, valor_total: f.valor_total.value, validade: f.validade.value })}); fecharModal('modal-vender-pacote'); f.reset(); mostrarAviso('Pacote vendido!'); setTimeout(() => { carregarPacotes(); }, 1500); } catch(e) { mostrarAviso('Erro'); } finally { setLoading(btn, false, originalText); } }
        async function salvarUsuario(e) { e.preventDefault(); const btn = document.getElementById('btn-salvar-usuario'); setLoading(btn, true, 'Salvar'); const f = e.target; try { await fetch(API_URL, {method:'POST', body:JSON.stringify({ action: 'createUsuario', nome: f.nome.value, email: f.email.value, senha: f.senha.value, nivel: f.nivel.value, cor: '#3b82f6' })}); fecharModal('modal-usuario'); f.reset(); carregarUsuarios(); mostrarAviso('Profissional adicionado!'); } catch(e) { mostrarAviso('Erro'); } finally { setLoading(btn, false, 'Salvar'); } }
        async function salvarEdicaoAgendamento(e) { e.preventDefault(); const btn = document.getElementById('btn-salvar-edicao-agenda'); const originalText = btn.innerText; setLoading(btn, true, originalText); const id = document.getElementById('edit-agenda-id').value; const novaData = document.getElementById('edit-agenda-data').value; const novoHorario = document.getElementById('edit-agenda-hora').value; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateAgendamentoDataHora', id_agendamento: id, data_agendamento: novaData, hora_inicio: novoHorario }) }); fecharModal('modal-editar-agendamento'); recarregarAgendaComFiltro(); mostrarAviso('Agendamento atualizado!'); } catch(err) { mostrarAviso('Erro.'); } finally { setLoading(btn, false, originalText); } }
        async function salvarNovoServico(e) { e.preventDefault(); const btn = document.getElementById('btn-salvar-servico'); const originalText = btn.innerText; setLoading(btn, true, originalText); const f = e.target; const fileInput = document.getElementById('input-imagem-servico'); let imagemUrl = ''; if (fileInput.files.length > 0) { btn.innerHTML = '<span class="spinner"></span> Enviando img...'; try { const formData = new FormData(); formData.append('image', fileInput.files[0]); const imgReq = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const imgRes = await imgReq.json(); if (imgRes.success) { imagemUrl = imgRes.data.url; } } catch (err) { console.error(err); } } try { await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'createServico', nome_servico:f.nome_servico.value, valor_unitario:f.valor_unitario.value, duracao_minutos:f.duracao_minutos.value, cor_hex:document.getElementById('input-cor-selecionada').value, imagem_url: imagemUrl, online_booking: document.getElementById('check-online-booking').checked })}); fecharModal('modal-servico'); f.reset(); carregarServicos(); } catch(e){ mostrarAviso('Erro'); } finally { setLoading(btn, false, originalText); } }
        async function salvarEdicaoServico(e) { e.preventDefault(); const btn = document.getElementById('btn-salvar-edicao-servico'); const originalText = btn.innerText; setLoading(btn, true, originalText); const f = e.target; const fileInput = document.getElementById('edit-input-imagem-servico'); let imagemUrl = ''; if (fileInput.files.length > 0) { btn.innerHTML = '<span class="spinner"></span> Enviando img...'; try { const formData = new FormData(); formData.append('image', fileInput.files[0]); const imgReq = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const imgRes = await imgReq.json(); if (imgRes.success) { imagemUrl = imgRes.data.url; } } catch (err) { console.error(err); } } try { await fetch(API_URL, {method:'POST', body:JSON.stringify({ action: 'updateServico', id_servico: f.id_servico.value, nome_servico: f.nome_servico.value, valor_unitario: f.valor_unitario.value, duracao_minutos: f.duracao_minutos.value, cor_hex: f.cor_hex.value, online_booking: document.getElementById('edit-check-online-booking').checked, imagem_url: imagemUrl })}); fecharModal('modal-editar-servico'); carregarServicos(); } catch(e) { mostrarAviso('Erro'); } finally { setLoading(btn, false, originalText); } }
        function renderizarListaServicos() { const container = document.getElementById('lista-servicos'); container.innerHTML = ''; servicosCache.forEach(s => { const div = document.createElement('div'); div.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center'; div.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold" style="background-color: ${getCorServico(s)}">${s.nome_servico.charAt(0)}</div><div><h4 class="font-bold text-slate-800">${s.nome_servico}</h4><p class="text-xs text-slate-500">${s.duracao_minutos} min • R$ ${parseFloat(s.valor_unitario).toFixed(2)}</p></div></div><button onclick="abrirModalEditarServico('${s.id_servico}')" class="text-slate-400 hover:text-blue-600"><i data-lucide="edit-2" class="w-5 h-5"></i></button>`; container.appendChild(div); }); lucide.createIcons(); }
        function renderizarListaPacotes() { const container = document.getElementById('lista-pacotes'); container.innerHTML = ''; if(!pacotesCache || pacotesCache.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 py-10">Nenhum pacote ativo.</div>'; return; } pacotesCache.forEach(p => { const div = document.createElement('div'); div.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100'; div.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-800">${p.nome_cliente}</h4><p class="text-xs text-slate-500">${p.nome_servico}</p></div><span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-lg">${p.qtd_restante}/${p.qtd_total}</span></div><div class="w-full bg-slate-100 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" style="width: ${(p.qtd_restante/p.qtd_total)*100}%"></div></div>`; container.appendChild(div); }); }
        function carregarServicos() { fetch(`${API_URL}?action=getServicos`).then(r=>r.json()).then(d=>{ servicosCache=d; renderizarListaServicos(); atualizarDatalistServicos(); }); }
        function carregarPacotes() { fetch(`${API_URL}?action=getPacotes`).then(r=>r.json()).then(d=>{ pacotesCache=d; renderizarListaPacotes(); }); }
        function carregarUsuarios() { fetch(`${API_URL}?action=getUsuarios`).then(r=>r.json()).then(d=>{ usuariosCache=d; renderizarListaUsuarios(); popularSelectsUsuarios(); }); }
        function adicionarItemAoPacote() { const nomeServico = document.getElementById('input-servico-pacote-nome').value; const qtdInput = document.getElementById('qtd-servico-pacote'); const qtd = parseInt(qtdInput.value); if(!nomeServico || qtd < 1) return; const servico = servicosCache.find(s => s.nome_servico.toLowerCase() === nomeServico.toLowerCase()); if(!servico) { mostrarAviso('Serviço não encontrado na lista.'); return; } const subtotal = (parseFloat(servico.valor_unitario || 0) * qtd); itensPacoteTemp.push({ id_servico: servico.id_servico, nome_servico: servico.nome_servico, valor_unitario: servico.valor_unitario, qtd: qtd, subtotal: subtotal }); atualizarListaVisualPacote(); atualizarTotalSugerido(); document.getElementById('input-servico-pacote-nome').value = ""; qtdInput.value = "1"; }
        function atualizarListaVisualPacote() { const container = document.getElementById('lista-itens-pacote'); container.innerHTML = ''; if(itensPacoteTemp.length === 0) { container.innerHTML = '<p class="text-xs text-slate-400 text-center py-2">Nenhum item adicionado.</p>'; return; } itensPacoteTemp.forEach((item, index) => { const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-white p-2 rounded border border-slate-100 text-sm'; const subtotalFmt = item.subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); div.innerHTML = ` <div class="flex-1"> <div class="flex justify-between items-center"> <span class="font-medium text-slate-700">${item.qtd}x ${item.nome_servico}</span> <span class="text-xs text-slate-500 font-medium ml-2">= ${subtotalFmt}</span> </div> </div> <button type="button" onclick="removerItemPacote(${index})" class="ml-3 text-red-400 hover:text-red-600 btn-anim"><i data-lucide="trash-2" class="w-4 h-4"></i></button> `; container.appendChild(div); }); lucide.createIcons(); }
        function removerItemPacote(index) { itensPacoteTemp.splice(index, 1); atualizarListaVisualPacote(); atualizarTotalSugerido(); }
        function atualizarTotalSugerido() { const total = itensPacoteTemp.reduce((acc, item) => acc + item.subtotal, 0); document.getElementById('valor-total-pacote').value = total.toFixed(2); }
        function verificarPacoteDisponivel() { const nomeCliente = document.getElementById('input-cliente-nome').value; const nomeServico = document.getElementById('input-servico-nome').value; const areaInfo = document.getElementById('area-pacote-info'); const checkbox = document.getElementById('check-usar-pacote'); const inputIdPacote = document.getElementById('id-pacote-selecionado'); areaInfo.classList.add('hidden'); inputIdPacote.value = ''; checkbox.checked = false; if(!nomeCliente || !nomeServico) return; const cliente = clientesCache.find(c => c.nome.toLowerCase() === nomeCliente.toLowerCase()); const servico = servicosCache.find(s => s.nome_servico.toLowerCase() === nomeServico.toLowerCase()); if(!cliente || !servico) return; const pacote = pacotesCache.find(p => String(p.id_cliente) === String(cliente.id_cliente) && String(p.id_servico) === String(servico.id_servico) && parseInt(p.qtd_restante) > 0); if(pacote) { areaInfo.classList.remove('hidden'); areaInfo.classList.add('flex'); document.getElementById('pacote-saldo').innerText = pacote.qtd_restante; inputIdPacote.value = pacote.id_pacote; checkbox.checked = true; } }
        async function salvarNovoCliente(e) { e.preventDefault(); const btn = document.getElementById('btn-salvar-cliente'); setLoading(btn, true, 'Salvar'); const f = e.target; try { const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({ action: 'createCliente', nome: f.nome.value, whatsapp: f.whatsapp.value, email: f.email.value })}); const data = await res.json(); if(data.status === 'sucesso') { clientesCache.push({ id_cliente: data.id_cliente, nome: data.nome }); atualizarDatalistClientes(); document.getElementById('input-cliente-nome').value = data.nome; fecharModal('modal-cliente'); f.reset(); mostrarAviso('Cliente cadastrado!'); } else { mostrarAviso('Erro ao cadastrar.'); } } catch(e) { mostrarAviso('Erro de conexão.'); } finally { setLoading(btn, false, 'Salvar'); } }
        function abrirDetalhesPacote(grupo) { const modal = document.getElementById('modal-detalhes-pacote'); const divSaldos = document.getElementById('tab-modal-saldos'); const divHist = document.getElementById('tab-modal-historico'); divSaldos.innerHTML = ''; divHist.innerHTML = ''; const idsPacotesDoGrupo = grupo.itens.map(i => String(i.id_pacote)); grupo.itens.forEach(item => { const servico = servicosCache.find(s => String(s.id_servico) === String(item.id_servico)); const nome = servico ? servico.nome_servico : 'Serviço'; const percent = (item.qtd_restante / item.qtd_total) * 100; divSaldos.innerHTML += `<div class="mb-2"><div class="flex justify-between text-sm mb-1"><span class="text-slate-700 font-medium">${nome}</span><span class="text-blue-600 font-bold">${item.qtd_restante}/${item.qtd_total}</span></div><div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ${percent}%"></div></div></div>`; }); const historico = agendamentosCache.filter(ag => { const idUsado = String(ag.id_pacote_usado || ag.id_pacote || ''); return idsPacotesDoGrupo.includes(idUsado); }); if (historico.length === 0) { divHist.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">Nenhum uso registrado hoje.</p>'; } else { historico.forEach(h => { const servico = servicosCache.find(s => String(s.id_servico) === String(h.id_servico)); const nomeServico = servico ? servico.nome_servico : 'Serviço'; const statusClass = h.status === 'Concluido' ? 'text-green-600' : (h.status === 'Cancelado' ? 'text-red-400 line-through' : 'text-blue-600'); divHist.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 text-sm"><div><p class="font-bold text-slate-700">${formatarDataBr(h.data_agendamento)} <span class="font-normal text-xs text-slate-400">${h.hora_inicio}</span></p><p class="text-xs text-slate-500">${nomeServico}</p></div><span class="text-xs font-bold uppercase ${statusClass}">${h.status}</span></div>`; }); } modal.classList.add('open'); }
        async function salvarConfigAPI(btn) { const originalText = btn.innerText; setLoading(btn, true, originalText); const abertura = document.getElementById('cfg-abertura').value; const fechamento = document.getElementById('cfg-fechamento').value; const intervalo = document.getElementById('cfg-intervalo').value; const encaixe = document.getElementById('cfg-concorrencia').checked; try { await fetch(API_URL, {method:'POST', body:JSON.stringify({ action: 'saveConfig', abertura: abertura, fechamento: fechamento, intervalo_minutos: intervalo, permite_encaixe: encaixe })}); config = { abertura, fechamento, intervalo_minutos: intervalo, permite_encaixe: encaixe }; renderizarGrade(); mostrarAviso('Configurações salvas!'); } catch(e) { mostrarAviso('Erro ao salvar.'); } finally { setLoading(btn, false, originalText); } }

    </script>
</body>
</html>
